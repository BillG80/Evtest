from smbus2 import SMBus
import time

class SSD1306:
    """Driver for SSD1306 OLED display."""
    
    def __init__(self, bus):
        """Initialize the SSD1306 OLED display."""
        self.bus = SMBus(bus)
        self.addr = 0x3C
        
        # Display settings
        self.width = 128
        self.height = 32
        self.pages = 4  # height/8
        
        # Init sequence
        self._init()
        
    def _init(self):
        """Initialize OLED display."""
        # Turn off display
        self._cmd(0xAE)
        
        # Set clock and multiplex
        self._cmd(0xD5, 0x80)  # Clock
        self._cmd(0xA8, 0x1F)  # Multiplex (HEIGHT-1)
        
        # Set display offset and start line
        self._cmd(0xD3, 0x00)  # Offset
        self._cmd(0x40)        # Start line
        
        # Enable charge pump
        self._cmd(0x8D, 0x14)
        
        # Configure memory mode and rotation
        self._cmd(0x20, 0x00)  # Memory mode
        self._cmd(0xA1)        # Segment remap
        self._cmd(0xC8)        # COM scan direction
        
        # Set COM pins and contrast
        self._cmd(0xDA, 0x02)  # COM pins
        self._cmd(0x81, 0x8F)  # Contrast
        
        # Turn on display
        self._cmd(0xAF)
        
        # Clear display
        self.clear()
        
        # Initialize font
        self._init_font()
    
    def _cmd(self, *args):
        """Send command to display."""
        for cmd in args:
            self.bus.write_byte_data(self.addr, 0x00, cmd)
    
    def _data(self, data):
        """Send data to display."""
        self.bus.write_byte_data(self.addr, 0x40, data)
    
    def clear(self):
        """Clear display memory."""
        for page in range(self.pages):
            self._cmd(0xB0 + page)  # Set page
            self._cmd(0x02, 0x10)   # Reset column
            for i in range(self.width):
                self._data(0x00)

    def display_measurements(self, pressure, accel, temp, alt):
        """Display measurements on OLED."""
        # Format strings (16 chars per line)
        line1 = f"P:{pressure:6.1f} C:{accel:5.2f}"
        line2 = f"T:{temp:6.1f} A:{alt:5.0f}"
        
        self.clear()
        self._write_line(line1, 0)  # Write to pages 0-1
        self._write_line(line2, 2)  # Write to pages 2-3
    
    def _write_line(self, text, start_page):
        """Write a line of text starting at given page."""
        x = 0
        for char in text:
            if x >= self.width - 8:  # Stop at end of line
                break
            self._write_char(char, x, start_page)
            x += 8  # 8 pixels per character
    
    def _write_char(self, char, x, page):
        """Write a 8x16 character."""
        char_data = self._font.get(char, self._font['?'])
        
        # Write top half (page N)
        self._cmd(0xB0 + page)  # Set page
        self._cmd(0x02 + (x & 0x0F))  # Column low
        self._cmd(0x10 + (x >> 4))    # Column high
        for byte in char_data[:8]:     # First 8 bytes
            self._data(byte)
        
        # Write bottom half (page N+1)
        self._cmd(0xB0 + page + 1)
        self._cmd(0x02 + (x & 0x0F))
        self._cmd(0x10 + (x >> 4))
        for byte in char_data[8:]:     # Last 8 bytes
            self._data(byte)

    def _init_font(self):
        """Initialize 8x16 font data."""
        # Each character is 16 bytes (8x16 pixels)
        self._font = {
            ' ': [0x00]*16,
            '0': [0x1E,0x33,0x33,0x33,0x33,0x33,0x1E,0x00,
                  0x1E,0x33,0x33,0x33,0x33,0x33,0x1E,0x00],
            '1': [0x0C,0x1C,0x3C,0x0C,0x0C,0x0C,0x3F,0x00,
                  0x0C,0x1C,0x3C,0x0C,0x0C,0x0C,0x3F,0x00],
            '2': [0x1E,0x33,0x03,0x06,0x0C,0x18,0x3F,0x00,
                  0x1E,0x33,0x03,0x06,0x0C,0x18,0x3F,0x00],
            '3': [0x1E,0x33,0x03,0x0E,0x03,0x33,0x1E,0x00,
                  0x1E,0x33,0x03,0x0E,0x03,0x33,0x1E,0x00],
            '4': [0x06,0x0E,0x1E,0x36,0x3F,0x06,0x06,0x00,
                  0x06,0x0E,0x1E,0x36,0x3F,0x06,0x06,0x00],
            '5': [0x3F,0x30,0x3E,0x03,0x03,0x33,0x1E,0x00,
                  0x3F,0x30,0x3E,0x03,0x03,0x33,0x1E,0x00],
            '6': [0x1E,0x33,0x30,0x3E,0x33,0x33,0x1E,0x00,
                  0x1E,0x33,0x30,0x3E,0x33,0x33,0x1E,0x00],
            '7': [0x3F,0x33,0x06,0x0C,0x0C,0x0C,0x0C,0x00,
                  0x3F,0x33,0x06,0x0C,0x0C,0x0C,0x0C,0x00],
            '8': [0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E,0x00,
                  0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E,0x00],
            '9': [0x1E,0x33,0x33,0x1F,0x03,0x33,0x1E,0x00,
                  0x1E,0x33,0x33,0x1F,0x03,0x33,0x1E,0x00],
            '.': [0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,
                  0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x00],
            ':': [0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x00,
                  0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x00],
            'P': [0x3E,0x33,0x33,0x3E,0x30,0x30,0x30,0x00,
                  0x3E,0x33,0x33,0x3E,0x30,0x30,0x30,0x00],
            'T': [0x3F,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x00,
                  0x3F,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x00],
            'C': [0x1E,0x33,0x30,0x30,0x30,0x33,0x1E,0x00,
                  0x1E,0x33,0x30,0x30,0x30,0x33,0x1E,0x00],
            'A': [0x1E,0x33,0x33,0x3F,0x33,0x33,0x33,0x00,
                  0x1E,0x33,0x33,0x3F,0x33,0x33,0x33,0x00],
            '-': [0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00,
                  0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00],
            '?': [0x1E,0x33,0x03,0x06,0x0C,0x00,0x0C,0x00,
                  0x1E,0x33,0x03,0x06,0x0C,0x00,0x0C,0x00]
        }

    def show_init_message(self, message):
        """Show initialization message."""
        try:
            # Clear image
            self.clear()
            
            # Draw initialization message in the middle of the screen
            self.display_text(message, 2, 8)
            
        except Exception as e:
            print(f"Display error: {e}")
            time.sleep(0.1)

    def shutdown(self):
        """Properly shutdown the display."""
        self.clear()
        self._cmd(0xAE)  # Turn off display
        self.bus.close()
